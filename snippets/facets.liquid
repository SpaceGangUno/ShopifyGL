{% comment %}
  Renders facets (filtering and sorting)

  Accepts:
  - results: {Object} Collection or Search object
  - enable_filtering: {Boolean} Show filtering when true
  - enable_sorting: {Boolean} Show sorting when true
  - filter_type: {String} Type of filter
  - paginate: {Object}

  Usage:
  {% render 'facets', results: collection, enable_filtering: true, enable_sorting: true, filter_type: 'vertical', paginate: paginate %}
{% endcomment %}

{{ 'component-show-more.css' | asset_url | stylesheet_tag }}
{{ 'component-swatch-input.css' | asset_url | stylesheet_tag }}
{{ 'component-swatch.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign sort_by = results.sort_by | default: results.default_sort_by
  assign total_active_values = 0
  assign default_presentation = 'text'
  if results.url
    assign results_url = results.url
  else
    assign terms = results.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif

  # Collect all available sizes from product variants
  assign all_sizes = ''
  for product in results.products
    for variant in product.variants
      assign size = variant.option1 | downcase
      unless all_sizes contains size
        assign all_sizes = all_sizes | append: size | append: ','
      endunless
    endfor
  endfor
  assign size_array = all_sizes | split: ','
  assign size_array = size_array | sort | uniq
-%}

<div class="facets-container{% if filter_type == 'drawer' %} facets-container-drawer{% endif %}{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--fade-in{% endif %}">
  {%- if filter_type == 'vertical' or filter_type == 'horizontal' -%}
    <facet-filters-form class="facets small-hide">
      <form
        id="FacetFiltersForm"
        class="{% if filter_type == 'horizontal' %}facets__form{% else %}facets__form-vertical{% endif %}"
      >
        {%- if results.terms -%}
          <input type="hidden" name="q" value="{{ results.terms | escape }}">
          <input name="options[prefix]" type="hidden" value="last">
        {%- endif -%}

        {% if enable_filtering %}
          <div
            id="FacetsWrapperDesktop"
            {% if filter_type == 'horizontal' %}
              class="facets__wrapper"
            {% endif %}
          >
            {%- if filter_type == 'horizontal' and results.filters != empty -%}
              <h2 class="facets__heading caption-large text-body" id="verticalTitle" tabindex="-1">
                {{ 'products.facets.filter_by_label' | t }}
              </h2>
            {%- endif -%}

            {%- if filter_type == 'vertical' -%}
              <div class="active-facets active-facets-desktop">
                <div class="active-facets-vertical-filter">
                  <h2
                    class="facets__heading facets__heading--vertical caption-large text-body"
                    id="verticalTitle"
                    tabindex="-1"
                  >
                    {{ 'products.facets.filter_by_label' | t }}
                  </h2>
                  <facet-remove class="active-facets__button-wrapper">
                    <a href="{{ results_url }}" class="active-facets__button-remove underlined-link">
                      <span>{{ 'products.facets.clear_all' | t }}</span>
                    </a>
                  </facet-remove>
                </div>
              </div>
            {%- endif -%}

            <details
              id="Details-Size-Filter-{{ section.id }}"
              class="{% if filter_type == 'horizontal' %}disclosure-has-popup facets__disclosure{% else %} facets__disclosure-vertical{% endif %} js-filter"
              data-index="1"
              {% if filter_type == 'vertical' %}
                open
              {% endif %}
            >
              <summary class="facets__summary caption-large focus-offset">
                <div>
                  <span>Size</span>
                  {{- 'icon-caret.svg' | inline_asset_content -}}
                </div>
              </summary>
              <div class="facets__display">
                <div class="facets__header">
                  <span class="facets__selected">Filter by size</span>
                  <facet-remove>
                    <a href="{{ results_url }}" class="facets__reset link underlined-link">
                      {{ 'products.facets.reset' | t }}
                    </a>
                  </facet-remove>
                </div>

                <ul class="facets__list list-unstyled" role="list">
                  {%- for size in size_array -%}
                    {% if size != blank %}
                      <li class="list-menu__item facets__item">
                        <label for="Filter-Size-{{ forloop.index }}" class="facets__label">
                          <input
                            type="checkbox"
                            name="filter.v.option.size"
                            value="{{ size }}"
                            id="Filter-Size-{{ forloop.index }}"
                            {% if results.current_vendor %}
                              {% if results.current_vendor == size %}
                                checked
                              {% endif %}
                            {% endif %}
                          >
                          {{- 'square.svg' | inline_asset_content -}}
                          <span class="facet-checkbox__text">
                            {{ size | capitalize }}
                          </span>
                        </label>
                      </li>
                    {% endif %}
                  {%- endfor -%}
                </ul>
              </div>
            </details>

            {% comment %} Price Range Filter {% endcomment %}
            {%- for filter in results.filters -%}
              {% if filter.type == 'price_range' %}
                <details
                  id="Details-{{ filter.param_name | escape }}-{{ section.id }}"
                  class="{% if filter_type == 'horizontal' %}disclosure-has-popup facets__disclosure{% else %} facets__disclosure-vertical{% endif %} js-filter"
                  data-index="2"
                >
                  <summary class="facets__summary caption-large focus-offset">
                    <div>
                      <span>{{ filter.label | escape }}</span>
                      {{- 'icon-caret.svg' | inline_asset_content -}}
                    </div>
                  </summary>
                  <div class="facets__display">
                    <div class="facets__header">
                      <span class="facets__selected">
                        {{- 'products.facets.max_price' | t: price: filter.range_max | money -}}
                      </span>
                      <facet-remove>
                        <a href="{{ filter.url_to_remove }}" class="facets__reset link underlined-link">
                          {{ 'products.facets.reset' | t }}
                        </a>
                      </facet-remove>
                    </div>
                    <price-range class="facets__price">
                      {% render 'price-facet',
                        filter: filter,
                        id_prefix: 'Filter-',
                        filter_type: filter_type
                      %}
                    </price-range>
                  </div>
                </details>
              {% endif %}
            {%- endfor -%}
          </div>
        {% endif %}

        {%- if enable_sorting -%}
          <div class="facet-filters sorting caption">
            <div class="facet-filters__field">
              <h2 class="facet-filters__label caption-large text-body">
                <label for="SortBy">{{ 'products.facets.sort_by_label' | t }}</label>
              </h2>
              <div class="select">
                <select
                  name="sort_by"
                  class="facet-filters__sort select__select caption-large"
                  id="SortBy"
                  aria-describedby="a11y-refresh-page-message"
                >
                  {%- for option in results.sort_options -%}
                    <option
                      value="{{ option.value | escape }}"
                      {% if option.value == sort_by %}
                        selected="selected"
                      {% endif %}
                    >
                      {{ option.name | escape }}
                    </option>
                  {%- endfor -%}
                </select>
                <span class="svg-wrapper">
                  {{- 'icon-caret.svg' | inline_asset_content -}}
                </span>
              </div>
            </div>
          </div>
        {%- endif -%}

        <div class="product-count light" role="status">
          <h2 class="product-count__text text-body">
            <span id="ProductCount">
              {%- if results.results_count -%}
                {{ 'templates.search.results_with_count' | t: terms: results.terms, count: results.results_count }}
              {%- elsif results.products_count == results.all_products_count -%}
                {{ 'products.facets.product_count_simple' | t: count: results.products_count }}
              {%- else -%}
                {{
                  'products.facets.product_count'
                  | t: product_count: results.products_count, count: results.all_products_count
                }}
              {%- endif -%}
            </span>
          </h2>
          {%- render 'loading-spinner' -%}
        </div>
      </form>
    </facet-filters-form>
  {%- endif -%}

  {% comment %} Mobile facets {% endcomment %}
  {% render 'facets-mobile',
    results: results,
    enable_filtering: enable_filtering,
    enable_sorting: enable_sorting,
    filter_type: filter_type,
    size_array: size_array
  %}
</div>
